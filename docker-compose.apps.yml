services:
  auth:
    build:
      context: .
      dockerfile: apps/auth/Dockerfile
    container_name: auth
    restart: always
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=auth
    ports:
      - "50051:50051"
    networks:
      - backplane
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"require('net').connect(50051,'127.0.0.1').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))\"" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    cpus: "0.5"
    mem_limit: "512m"

  tickets:
    build:
      context: .
      dockerfile: apps/tickets/Dockerfile
    container_name: tickets
    restart: always
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=tickets
    ports:
      - "8001:8001"
    networks:
      - backplane
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"require('net').connect(8001,'127.0.0.1').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))\"" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    cpus: "0.75"
    mem_limit: "768m"

  notifications:
    build:
      context: .
      dockerfile: apps/notifications/Dockerfile
    container_name: notifications
    restart: always
    env_file:
      - .env
    networks:
      - backplane
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"process.kill(1,0)\"" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    cpus: "0.5"
    mem_limit: "512m"

networks:
  backplane:
    name: backplane
